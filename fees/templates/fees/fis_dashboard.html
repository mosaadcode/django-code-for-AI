{% extends 'fis/base2.html' %}

{% block content %}
{% load static %}
{% load fee_filters %}
<link rel="stylesheet" href="{% static '/css/base.css' %}">

{% if error %}
<div class="alert alert-danger text-center" role="alert">
	{{ error }}
</div>
{% endif %}
{% if msg %}
<div class="alert alert-info text-center" role="alert">
	{{ msg }}
</div>
{% endif %}

<div class="container-fluid text-left mt-1">
	<div class="row">
		<div class="col-md-12">
			<div class="card text-center border-black" style="background-color: transparent;">
				<h6 class="card-header">
					{{ user.username }}
				</h6>
				<div class="card-footer ">
			{{ user.get_grade_display }} - {{ user.school }}
				</div>
			</div>
		</div>
	</div>

	<div class="row">
		<div class="col-md-12 ml-auto text-left">
			<div id="card-434025">
				<div class="card" style="background-color: transparent;">
					<div class="card-header d-flex justify-content-between align-items-center">
							<a class="card-link collapsed" data-toggle="collapse" data-parent="#card-434025" href="#card-element-708669">
								Payment Details
							</a>
					</div>
					<div id="card-element-708669" class="collapse">
						<div class="card-body">
								<img src="{% static 'images/FisPayment.jpg'%}" class="img-fluid" alt="">
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<div class="row  mt-2 ">
		<div class="col-md-6">
		</div>
		{% if user.message %}
		<div class="col-md-6">
			<div class="alert alert-dismissable alert-primary">

				<button type="button" class="close" data-dismiss="alert" aria-hidden="true">
					×
				</button>
				<h6>
					<!-- بريد -->
				</h6>{{ user.message|safe }}
			</div>
		</div>
		{% else %}
		<div class="col-md-6">
				</div>
		{% endif %}
	</div>

	<div class="container py-0">
	<div class="row">
		<div class="col-lg-8 mx-auto">
			<div class="card shadow-lg rounded-lg overflow-hidden" style="background-color: transparent;">
				<div class="card-header bg-gradient-primary p-0">
					<ul class="nav nav-tabs justify-content-start" id="myTab" role="tablist">
						<li class="nav-item" role="presentation">
							<button class="nav-link active" id="fees-tab" data-bs-toggle="tab" data-bs-target="#fees" type="button" role="tab" aria-controls="fees" aria-selected="true">
								Tuition Fees <i class="fa fa-graduation-cap me-2"></i>   
							</button>
						</li>
						{% comment %} {% if user.bus_active %} {% endcomment %}
						<li class="nav-item" role="presentation">
							<button class="nav-link" id="car-tab" data-bs-toggle="tab" data-bs-target="#car" type="button" role="tab" aria-controls="car" aria-selected="false">
								Bus Fees <i class="fa fa-bus me-2"></i> 
							</button>
						</li>
						{% comment %} {% endif %} {% endcomment %}
						<li class="nav-item" role="presentation">
							<button class="nav-link" id="books-tab" data-bs-toggle="tab" data-bs-target="#books" type="button" role="tab" aria-controls="books" aria-selected="false">   
								Books <i class="fa fa-book me-2"></i> 
							</button>
						</li>
						<li class="nav-item" role="presentation">
							<button class="nav-link" id="tours-tab" data-bs-toggle="tab" data-bs-target="#tours" type="button" role="tab" aria-controls="tours" aria-selected="false">   
								Other <i class="fa fa-money-bill-wave me-2"></i> 
							</button>
						</li>
					</ul>
				</div>
				<div class="card-body">
					<div class="tab-content" id="myTabContent">
						<div class="tab-pane fade show active" id="fees" role="tabpanel" aria-labelledby="fees-tab">
							<div class="position-absolute top-0 start-0 p-0 ml-2 mt-2">
								<h5 class="mb-0">
									Tuition fees
								</h5>
							</div>

							<div class="card-header bg-gradient-primary text-right py-1 px-0">
								<span class="badge badge-outlined rounded-pill fs-4 py-1 px-4 text-dark ml-1 mt-1" style="border: 2px solid #ffffff; font-size: 1.0rem;">
									{{ study_total_payments }}
								</span>
							</div>

							<div class="card-body px-0">
								<div class="table-responsive">
									<table class="table table-striped table-hover">
										<thead class="thead-light">
											<tr>
												<th>Payment</th>
												<th>Before</th>
												<th>State</th>
											</tr>
										</thead>
										<tbody>
											{% for payment in study_payment_data %}
											<tr style="height: 20px;">
												<td>
													<span class="border border-secondary text-secondary rounded-circle p-1 d-inline-flex justify-content-center align-items-center" style="width: 20px; height: 20px;">
														<i class="fa-solid fa-{{ payment.number }}"></i>
													</span>
												</td>
												<td>{{ payment.date|date:"M d" }}</td>
												<td>
													{% if payment.status == 'Complete' %}
													<span class="badge bg-success d-inline-block text-center py-1 px-2 rounded-pill shadow-sm text-white" style="width:100px; font-size: 0.875rem;">Paid</span>
													{% else %}
													<form action="{% url 'pay_online' %}" method="POST">
														{% csrf_token %}
														<input type="hidden" name="value" value="{{ payment.remaining }}">
														<input type="hidden" name="kind" value="Study Fees">
														<input type="hidden" name="year" value="{{ next_year }}">
														<button type="submit" class="btn btn-danger btn-sm px-2 py-0 rounded-pill shadow-sm" style="width:120px;">
															Pay {{ payment.remaining }} <i class="fa fa-credit-card ml-1"></i>
														</button>
													</form>
													{% endif %}
												</td>
											</tr>
											{% endfor %}
										</tbody>
										<tfoot>
											<tr>
												<th>Paid</th>
												<th>{{ study_total_paid }}</th>
												<th></th>
											</tr>
											{% if student_discount > 0 %}
											<tr>
												<th>Discount</th>
												<th>{{ student_discount }}</th>
												<th></th>
											</tr>
											{% endif %}
											<tr>
												<th>Remain</th>
												<th>{{ study_total_due }}</th>
												<th>
													{% if study_total_due > 0 %}
													<form action="{% url 'pay_online' %}" method="POST">
														{% csrf_token %}
														<input type="hidden" name="value" value="{{ study_total_due }}">
														<input type="hidden" name="kind" value="Study Fees">
														<input type="hidden" name="year" value="{{ next_year }}">
														<button type="submit" class="btn btn-danger btn-sm px-2 py-1 rounded-pill shadow-sm w-100">
															Pay {{ study_total_due }} <i class="fa fa-credit-card ml-3"></i>
														</button>
													</form>
													{% endif %}
												</th>
											</tr>
										</tfoot>
									</table>
								</div>
							</div>
						</div>
						<div class="tab-pane fade" id="car" role="tabpanel" aria-labelledby="car-tab">
							{% if bus  %}
								<div class="position-absolute top-0 start-0 p-0 ml-2 mt-2">
									<h5 class="mb-0">
										School bus fees
									</h5>
								</div>

								<div class="card-header bg-gradient-primary text-right py-1 px-0">
									<span class="badge badge-outlined rounded-pill fs-4 py-1 px-4 text-dark ml-1 mt-1" style="border: 2px solid #ffffff; font-size: 1.0rem;">
										{{ bus_total_payments }}
									</span>
								</div>

								<div class="card-body px-0">
									<div class="table-responsive">
										<table class="table table-striped table-hover">
											<thead class="thead-light">
												<tr>
													<th>Payment</th>
													<th>Before</th>
													<th>State</th>
												</tr>
											</thead>
											<tbody>
												{% for payment in bus_payment_data %}
												<tr style="height: 20px;">
													<td>
														<span class="border border-secondary text-secondary rounded-circle p-1 d-inline-flex justify-content-center align-items-center" style="width: 20px; height: 20px;">
															<i class="fa-solid fa-{{ payment.number }}"></i>
														</span>
													</td>
													<td>{{ payment.date|date:"M d" }}</td>
													<td>
														{% if payment.status == 'Complete' %}
														<span class="badge bg-success d-inline-block text-center py-1 px-2 rounded-pill shadow-sm text-white" style="width:100px; font-size: 0.875rem;">Paid</span>
														{% else %}
														<form action="{% url 'pay_online' %}" method="POST">
															{% csrf_token %}
															<input type="hidden" name="value" value="{{ payment.remaining }}">
															<input type="hidden" name="kind" value="Bus Fees">
															<input type="hidden" name="year" value="{{ next_year }}">
															<button type="submit" class="btn btn-danger btn-sm px-2 py-0 rounded-pill shadow-sm" style="width:120px;">
																Pay {{ payment.remaining }} <i class="fa fa-credit-card ml-1"></i>
															</button>
														</form>
														{% endif %}
													</td>
												</tr>
												{% endfor %}
											</tbody>
											<tfoot>
												<tr>
													<th>Paid</th>
													<th>{{ bus_total_paid }}</th>
													<th></th>
												</tr>
												{% if student_bus_discount > 0 %}
												<tr>
													<th>Discount</th>
													<th>{{ student_bus_discount }}</th>
													<th></th>
												</tr>
												{% endif %}
												<tr>
													<th>Remain</th>
													<th>{{ bus_total_due }}</th>
													<th>
														{% if bus_total_due > 0 %}
														<form action="{% url 'pay_online' %}" method="POST">
															{% csrf_token %}
															<input type="hidden" name="value" value="{{ Bus_total_due }}">
															<input type="hidden" name="kind" value="Bus Fees">
															<input type="hidden" name="year" value="{{ next_year }}">
															<button type="submit" class="btn btn-danger btn-sm px-2 py-1 rounded-pill shadow-sm w-100">
																Pay {{ bus_total_due }} <i class="fa fa-credit-card ml-3"></i>
															</button>
														</form>
														{% endif %}
													</th>
												</tr>
											</tfoot>
										</table>
									</div>
								</div>
							{% else %}
								<form action="{% url 'agreement' %}" method="GET">
									{% csrf_token %}
									<button type="submit" class="btn btn-danger btn-sm px-2 py-1 rounded-pill shadow-sm" style="width:200px;">
										<i class="fa fa-credit-card mr-1"></i> Bus subscription
									</button>
								</form>
							{% endif %}
						</div>
						<div class="tab-pane fade" id="books" role="tabpanel" aria-labelledby="books-tab">
							<div class="card-body  mb-0 px-0">
								{% if books %}
									{% if book_types %}
										{% for book_type in book_types %}
										<div class="mb-4">
											<div class="position-absolute top-0 start-0 p-0 ml-2 mt-2">
												<h5 class="mb-0">
													Books fees
												</h5>
											</div>

											<div class="card-header bg-gradient-primary text-right py-1 px-0">
												<span class="badge badge-outlined rounded-pill fs-4 py-1 px-4 text-dark ml-1 mt-1" style="border: 2px solid #ffffff; font-size: 1.0rem;">
													{{ book_type.total_payments }}
												</span>
											</div>

											<div class="table-responsive mt-3">
												<table class="table table-striped table-hover">
													<thead class="thead-light">
														<tr>
															<th>Installment</th>
															<th>Amount</th>
															<th>Status</th>
														</tr>
													</thead>
													<tbody>
														{% for payment in book_type.payment_data %}
														<tr>
															<td>
																<span class="border border-secondary text-secondary rounded-circle p-1 d-inline-flex justify-content-center align-items-center" style="width: 20px; height: 20px;">
																	<i class="fa-solid fa-{{ payment.number }}"></i>
																</span>
															</td>
															<td>
																{{ payment.amount }}
															</td>
															<td>
																{% if payment.status == 'Complete' %}
																	<span class="badge bg-success d-inline-block text-center py-1 px-2 rounded-pill shadow-sm text-white" style="width:90px; font-size: 0.875rem;">Paid</span>
																{% else %}
																	<form action="{% url 'pay_online' %}" method="POST">
																		{% csrf_token %}
																		<input type="hidden" name="value" value="{{ payment.remaining }}">
																		<input type="hidden" name="kind" value="{{ book_type.key }}">
																		<input type="hidden" name="year" value="{{ next_year }}">
																		<button type="submit" class="btn btn-danger btn-sm px-2 py-0 rounded-pill shadow-sm" style="width:120px;">
																			<i class="fa fa-credit-card me-1"></i> Pay {{ payment.remaining }}
																		</button>
																	</form>
																{% endif %}
															</td>
														</tr>
														{% endfor %}
													</tbody>
													<tfoot>
														<tr>
															<th>Paid</th>
															<th>{{ book_type.total_paid }}</th>
															<th>
																{% if book_type.total_due > 0 %}
																<form action="{% url 'pay_online' %}" method="POST">
																	{% csrf_token %}
																	<input type="hidden" name="value" value="{{ book_type.total_due }}">
																	<input type="hidden" name="kind" value="{{ book_type.key }}">
																	<input type="hidden" name="year" value="{{ next_year }}">
																	<button type="submit" class="btn btn-danger btn-sm px-2 py-1 rounded-pill shadow-sm w-100">
																		<i class="fa fa-credit-card me-3"></i> Pay All {{ book_type.total_due }}
																	</button>
																</form>
																{% else %}
																<span class="badge bg-success d-inline-block text-center py-1 px-2 rounded-pill shadow-sm text-white" style="width:90px; font-size: 0.875rem;">All Paid</span>
																{% endif %}
															</th>
														</tr>
													</tfoot>
												</table>
											</div>
										</div>
										{% endfor %}
									{% else %}
										<div class="alert alert-info text-center mt-3">
											No books are currently available for payment
										</div>
									{% endif %}
								{% else %}
									<div class="alert alert-danger text-center mt-3">
										All due installments must be paid first
									</div>
								{% endif %}        
							</div>
						</div>
						<div class="tab-pane fade" id="tours" role="tabpanel" aria-labelledby="tours-tab">
							<div class="card-body px-0">
								<!-- Tours Fees Section (only show if student_pay_tours is True) -->
								{% if student_pay_tours and tours_fees_data %}
									<div class="mb-4">
										<div class="position-absolute top-0 start-0 p-0 ml-2 mt-2">
											<h5 class="mb-0">Activities and Trips</h5>
										</div>
										
										<div class="card-header bg-gradient-primary text-right py-1 px-0">
											<span class="badge badge-outlined rounded-pill fs-4 py-1 px-4 text-dark ml-1 mt-1" style="border: 2px solid #ffffff; font-size: 1.0rem;">
												{{ tours_total_amount }}
											</span>
										</div>
										
										<div class="table-responsive mt-3">
											<table class="table table-striped table-hover">
												<thead class="thead-light">
													<tr>
														<th>Description</th>
														<th>Amount</th>
													</tr>
												</thead>
												<tbody>
													{% for fee in tours_fees_data %}
													<tr>
														<td>{{ fee.name }}</td>
														<td>
															{% if fee.is_paid %}
																<span class="badge bg-success d-inline-block text-center py-2 px-2 rounded-pill shadow-sm text-white" style="width:120px; font-size: 0.875rem;">Paid</span>
															{% else %}
																<form action="{% url 'pay_online' %}" method="POST">
																	{% csrf_token %}
																	<input type="hidden" name="value" value="{{ fee.value }}">
																	<input type="hidden" name="kind" value="{{ fee.kind }}">
																	<input type="hidden" name="year" value="{{ next_year }}">
																	<input type="hidden" name="reference" value="{{ fee.reference }}">
																	<button type="submit" class="btn btn-danger btn-sm px-2 py-1 rounded-pill shadow-sm" style="width:120px;">
																		Pay {{ fee.value }} <i class="fa fa-credit-card ml-1"></i>
																	</button>
																</form>
															{% endif %}
														</td>
													</tr>
													{% endfor %}
												</tbody>
											</table>
										</div>
									</div>
								{% endif %}
								
								<!-- Other Fees Section (always show if available) -->
								{% if other_fees_data %}
									<div class="mb-4">
										<div class="position-absolute top-0 start-0 p-0 ml-2 mt-2">
											<h5 class="mb-0">Other Fees</h5>
										</div>
										
										<div class="card-header bg-gradient-primary text-right py-1 px-0">
											<span class="badge badge-outlined rounded-pill fs-4 py-1 px-4 text-dark ml-1 mt-1" style="border: 2px solid #ffffff; font-size: 1.0rem;">
												{{ other_fees_total_amount }}
											</span>
										</div>
										
										<div class="table-responsive mt-3">
											<table class="table table-striped table-hover">
												<thead class="thead-light">
													<tr>
														<th>Description</th>
														<th>Amount</th>
													</tr>
												</thead>
												<tbody>
													{% for fee in other_fees_data %}
													<tr>
														<td>{{ fee.name }}</td>
														<td>
															{% if fee.is_paid %}
																<span class="badge bg-success d-inline-block text-center py-2 px-2 rounded-pill shadow-sm text-white" style="width:120px; font-size: 0.875rem;">Paid</span>
															{% else %}
																<form action="{% url 'pay_online' %}" method="POST">
																	{% csrf_token %}
																	<input type="hidden" name="value" value="{{ fee.value }}">
																	<input type="hidden" name="kind" value="{{ fee.kind }}">
																	<input type="hidden" name="year" value="{{ next_year }}">
																	<input type="hidden" name="reference" value="{{ fee.reference }}">
																	<button type="submit" class="btn btn-danger btn-sm px-2 py-1 rounded-pill shadow-sm" style="width:120px;">
																		Pay {{ fee.value }} <i class="fa fa-credit-card ml-1"></i>
																	</button>
																</form>
															{% endif %}
														</td>
													</tr>
													{% endfor %}
												</tbody>
											</table>
										</div>
									</div>
								{% endif %}
								
								<!-- No Fees Message -->
								{% if not other_fees_data and not tours_fees_data %}
									<div class="alert alert-info text-center mt-3">
										No other fees available for payment at the moment
									</div>
								{% elif not other_fees_data and tours_fees_data and not student_pay_tours %}
									<div class="alert alert-info text-center mt-3">
										No other fees available for payment at the moment
									</div>
								{% endif %}
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<!-- Bootstrap Bundle with Popper -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
	// Ensure the DOM is fully loaded before initializing tabs
	document.addEventListener('DOMContentLoaded', function() {
		var triggerTabList = [].slice.call(document.querySelectorAll('#myTab button'))
		triggerTabList.forEach(function (triggerEl) {
			var tabTrigger = new bootstrap.Tab(triggerEl)
			triggerEl.addEventListener('click', function (event) {
				event.preventDefault()
				tabTrigger.show()
			})
		})
	});
</script>
{% endblock %}